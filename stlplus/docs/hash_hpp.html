<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>hash.hpp</title>
<meta http-equiv="generator" content="ccolour C++ colouriser by Andy Rushton">
</head>
<body lang="en">
<h1>hash.hpp</h1>
<pre style="background-color: #ffffff">

<span style="color: #990000">#ifndef</span> <span style="color: #000000">HASH_HPP</span>
<span style="color: #990000">#define</span> <span style="color: #000000">HASH_HPP</span>
<span style="color: #000099">/*----------------------------------------------------------------------------</span>
<span style="color: #000099"></span>
<span style="color: #000099">  Author:    Andy Rushton</span>
<span style="color: #000099">  Copyright: (c) Andy Rushton, 2004</span>
<span style="color: #000099">  License:   BSD License, see ../docs/license.html</span>
<span style="color: #000099"></span>
<span style="color: #000099">  A chained hash table using STL semantics</span>
<span style="color: #000099"></span>
<span style="color: #000099">------------------------------------------------------------------------------*/</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"os_fixes.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"textio.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"persistent.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"exceptions.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;map&gt;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// internals</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">&gt;</span> <span style="color: #990000">class</span> <span style="color: #000000">hash</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span> <span style="color: #990000">class</span> <span style="color: #000000">hash_element</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// iterator class</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">V</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">class</span> <span style="color: #000000">hash_iterator</span>
<span style="color: #330033">{</span>
<span style="color: #990000">public</span><span style="color: #330033">:</span>
  <span style="color: #990000">friend</span> <span style="color: #990000">class</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">;</span>

  <span style="color: #000099">// local type definitions</span>
  <span style="color: #000099">// an iterator points to a value whilst a const_iterator points to a const value</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">V</span>                                                  <span style="color: #000000">value_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span> <span style="color: #330033">&gt;</span>       <span style="color: #000000">iterator</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span> <span style="color: #330033">&gt;</span> <span style="color: #000000">const_iterator</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #000000">V</span><span style="color: #330033">&gt;</span>                           <span style="color: #000000">this_iterator</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">V</span><span style="color: #330033">&amp;</span>                                                 <span style="color: #000000">reference</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">V</span><span style="color: #330033">*</span>                                                 <span style="color: #000000">pointer</span><span style="color: #330033">;</span>

  <span style="color: #000099">// constructor to create a null iterator - you must assign a valid value to this iterator before using it</span>
  <span style="color: #000099">// any attempt to dereference or use a null iterator is an error</span>
  <span style="color: #000099">// the only valid thing you can do is assign an iterator to it</span>
  <span style="color: #000000">hash_iterator</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #330033">~</span><span style="color: #000000">hash_iterator</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// tests</span>
  <span style="color: #000099">// a null iterator is one that has not been initialised with a value yet</span>
  <span style="color: #000099">// i.e. you just declared it but didn't assign to it</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">null</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000099">// an end iterator is one that points to the end element of the list of nodes</span>
  <span style="color: #000099">// in STL conventions this is one past the last valid element and must not be dereferenced</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">end</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000099">// a valid iterator is one that can be dereferenced</span>
  <span style="color: #000099">// i.e. non-null and non-end</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">valid</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// get the hash container that created this iterator</span>
  <span style="color: #000099">// a null iterator doesn't have an owner so returns a null pointer</span>
  <span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">owner</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Type conversion methods allow const_iterator and iterator to be converted</span>
  <span style="color: #000099">// convert an iterator/const_iterator to a const_iterator</span>
  <span style="color: #000000">const_iterator</span> <span style="color: #000000">constify</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000099">// convert an iterator/const_iterator to an iterator</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">deconstify</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// increment operators used to step through the set of all values in a hash</span>
  <span style="color: #000099">// it is only legal to increment a valid iterator</span>
  <span style="color: #000099">// there's no decrement - I've only implemented this as a unidirectional iterator</span>
  <span style="color: #000099">// pre-increment</span>
  <span style="color: #000000">this_iterator</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span> <span style="color: #330033">+</span><span style="color: #330033">+</span> <span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// post-increment</span>
  <span style="color: #000000">this_iterator</span> <span style="color: #990000">operator</span> <span style="color: #330033">+</span><span style="color: #330033">+</span> <span style="color: #330033">(</span><span style="color: #990000">int</span><span style="color: #330033">)</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// tests useful for putting iterators into other STL structures and for testing whether iteration has completed</span>
  <span style="color: #990000">bool</span> <span style="color: #990000">operator</span> <span style="color: #330033">=</span><span style="color: #330033">=</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">this_iterator</span><span style="color: #330033">&amp;</span> <span style="color: #000000">r</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #990000">operator</span> <span style="color: #330033">!</span><span style="color: #330033">=</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">this_iterator</span><span style="color: #330033">&amp;</span> <span style="color: #000000">r</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #990000">operator</span> <span style="color: #330033">&lt;</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">this_iterator</span><span style="color: #330033">&amp;</span> <span style="color: #000000">r</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// access the value - a const_iterator gives you a const value, an iterator a non-const value</span>
  <span style="color: #000099">// it is illegal to dereference an invalid (i.e. null or end) iterator</span>
  <span style="color: #000000">reference</span> <span style="color: #990000">operator</span><span style="color: #330033">*</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000000">pointer</span> <span style="color: #990000">operator</span><span style="color: #330033">-&gt;</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Note: hash iterators are not persistent for a good reason: they are</span>
  <span style="color: #000099">// invalidated by rehashing and so it is not a good idea to build data</span>
  <span style="color: #000099">// structures containing hash iterators in the first place</span>

<span style="color: #990000">private</span><span style="color: #330033">:</span>
  <span style="color: #990000">friend</span> <span style="color: #990000">class</span> <span style="color: #000000">hash_element</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">;</span>

  <span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">m_owner</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #000000">m_bin</span><span style="color: #330033">;</span>
  <span style="color: #000000">hash_element</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">m_element</span><span style="color: #330033">;</span>

  <span style="color: #990000">void</span> <span style="color: #000000">check_owner</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">owner</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">wrong_object</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">check_non_null</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">check_non_end</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">check_valid</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">check</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">owner</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">wrong_object</span><span style="color: #330033">,</span><span style="color: #000000">null_dereference</span><span style="color: #330033">,</span><span style="color: #000000">end_dereference</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// constructor used by hash to create a non-null iterator</span>
  <span style="color: #000099">// you cannot create a valid iterator except by calling a hash method that returns one</span>
  <span style="color: #000000">hash_iterator</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">owner</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #000000">bin</span><span style="color: #330033">,</span> <span style="color: #000000">hash_element</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span> <span style="color: #000000">element</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #330033">}</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Hash class</span>
<span style="color: #000099">// K = key type</span>
<span style="color: #000099">// T = value type</span>
<span style="color: #000099">// H = hash function object with the profile 'unsigned H(const K&amp;)'</span>
<span style="color: #000099">// E = equal function object with the profile 'bool E(const K&amp;, const K&amp;)' defaults to equal_to which in turn calls '=='</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span> <span style="color: #330033">=</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">equal_to</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">&gt;</span> <span style="color: #330033">&gt;</span>
<span style="color: #990000">class</span> <span style="color: #000000">hash</span>
<span style="color: #330033">{</span>
<span style="color: #990000">public</span><span style="color: #330033">:</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">unsigned</span>                                <span style="color: #000000">size_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">K</span>                                       <span style="color: #000000">key_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">T</span>                                       <span style="color: #000000">data_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">T</span>                                       <span style="color: #000000">mapped_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>                   <span style="color: #000000">value_type</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #000000">value_type</span><span style="color: #330033">&gt;</span>       <span style="color: #000000">iterator</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #990000">const</span> <span style="color: #000000">value_type</span><span style="color: #330033">&gt;</span> <span style="color: #000000">const_iterator</span><span style="color: #330033">;</span>

  <span style="color: #000099">// construct a hash table with specified number of bins</span>
  <span style="color: #000099">// the default 0 bins means leave it to the table to decide</span>
  <span style="color: #000099">// specifying 0 bins also enables auto-rehashing, otherwise auto-rehashing defaults off</span>
  <span style="color: #000000">hash</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #000000">bins</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #330033">~</span><span style="color: #000000">hash</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// copy and equality copy the data elements but not the size of the copied table</span>
  <span style="color: #000000">hash</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000000">hash</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span> <span style="color: #330033">=</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// test for an empty table and for the size of a table - efficient because the size is stored separately from the table contents</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">empty</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #000000">size</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// test for equality - two hashes are equal if they contain equal values</span>
  <span style="color: #990000">bool</span> <span style="color: #990000">operator</span> <span style="color: #330033">=</span><span style="color: #330033">=</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #990000">operator</span> <span style="color: #330033">!</span><span style="color: #330033">=</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// switch auto-rehash on</span>
  <span style="color: #990000">void</span> <span style="color: #000000">auto_rehash</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// switch auto-rehash off</span>
  <span style="color: #990000">void</span> <span style="color: #000000">manual_rehash</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// force a rehash now</span>
  <span style="color: #000099">// default of 0 means implement built-in size calculation for rehashing (recommended - it doubles the number of bins)</span>
  <span style="color: #990000">void</span> <span style="color: #000000">rehash</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #000000">bins</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// test the loading ratio, which is the size divided by the number of bins</span>
  <span style="color: #000099">// use this if you are doing your own rehashing</span>
  <span style="color: #000099">// the recommendation is to double the bins when the loading exceeds 0.5 which is what auto-rehashing does</span>
  <span style="color: #990000">float</span> <span style="color: #000000">loading</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// test for the presence of a key</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">present</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000099">// provide map equivalent key count function (0 or 1, as not a multimap)</span>
  <span style="color: #000000">size_type</span> <span style="color: #000000">count</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// insert a new key/data pair - replaces any previous value for this key</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">insert</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// insert a copy of the pair into the table (std::map compatible)</span>
  <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #000000">iterator</span><span style="color: #330033">,</span> <span style="color: #990000">bool</span><span style="color: #330033">&gt;</span> <span style="color: #000000">insert</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">value_type</span><span style="color: #330033">&amp;</span> <span style="color: #000000">value</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// insert a new key and return the iterator so that the data can be filled in</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">insert</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// remove a key/data pair from the hash table</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">erase</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// remove all elements from the hash table</span>
  <span style="color: #990000">void</span> <span style="color: #000000">erase</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// provide the std::map equivalent clear function</span>
  <span style="color: #990000">void</span> <span style="color: #000000">clear</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// find a key and return an iterator to it</span>
  <span style="color: #000099">// The iterator is like a pointer to a pair&lt;const K,T&gt;</span>
  <span style="color: #000099">// end() is returned if the find fails</span>
  <span style="color: #000000">const_iterator</span> <span style="color: #000000">find</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">find</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// returns the data corresponding to the key</span>
  <span style="color: #000099">// the const version is used by the compiler on const hashes and cannot change the hash, so find failure causes an exception</span>
  <span style="color: #000099">// the non-const version is used by the compiler on non-const hashes and is like map - it creates a new key/data pair if find fails</span>
  <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span><span style="color: #330033">[</span><span style="color: #330033">]</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span><span style="color: #330033">[</span><span style="color: #330033">]</span> <span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">&amp;</span> <span style="color: #000000">key</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// iterators allow the hash table to be traversed</span>
  <span style="color: #000099">// iterators remain valid unless an item is removed or unless a rehash happens</span>
  <span style="color: #000000">const_iterator</span> <span style="color: #000000">begin</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">begin</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000000">const_iterator</span> <span style="color: #000000">end</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">iterator</span> <span style="color: #000000">end</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// diagnostic report shows the number of items in each bin so can be used to diagnose effectiveness of hash functions</span>
  <span style="color: #990000">void</span> <span style="color: #000000">debug_report</span><span style="color: #330033">(</span><span style="color: #000000">otext</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #000000">indent</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000099">// the same diagnostic function that returns a string, rather than use an otext stream</span>
  <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span> <span style="color: #000000">debug_report</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #000000">indent</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// persistence methods</span>
  <span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span>
    <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// internals</span>
<span style="color: #990000">private</span><span style="color: #330033">:</span>
  <span style="color: #990000">friend</span> <span style="color: #990000">class</span> <span style="color: #000000">hash_element</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">;</span>
  <span style="color: #990000">friend</span> <span style="color: #990000">class</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span> <span style="color: #330033">&gt;</span><span style="color: #330033">;</span>
  <span style="color: #990000">friend</span> <span style="color: #990000">class</span> <span style="color: #000000">hash_iterator</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">,</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span> <span style="color: #330033">&gt;</span><span style="color: #330033">;</span>

  <span style="color: #990000">unsigned</span> <span style="color: #000000">m_rehash</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #000000">m_bins</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #000000">m_size</span><span style="color: #330033">;</span>
  <span style="color: #000000">hash_element</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">*</span><span style="color: #330033">*</span> <span style="color: #000000">m_values</span><span style="color: #330033">;</span>
<span style="color: #330033">}</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">&gt;</span>
<span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">print</span><span style="color: #330033">(</span><span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">str</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">table</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #000000">indent</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">&gt;</span>
<span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span> <span style="color: #330033">&lt;&lt;</span> <span style="color: #330033">(</span><span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">str</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">table</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_hash</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span> <span style="color: #000000">str</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">H</span><span style="color: #330033">,</span> <span style="color: #990000">class</span> <span style="color: #000000">E</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_hash</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span> <span style="color: #000000">str</span><span style="color: #330033">,</span> <span style="color: #000000">hash</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">H</span><span style="color: #330033">,</span><span style="color: #000000">E</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #990000">#include</span> <span style="color: #009900">"hash.tpp"</span>
<span style="color: #990000">#endif</span>
</pre>
</body>
</html>
