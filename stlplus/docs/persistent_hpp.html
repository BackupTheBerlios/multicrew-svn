<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>persistent.hpp</title>
<meta http-equiv="generator" content="ccolour C++ colouriser by Andy Rushton">
</head>
<body lang="en">
<h1>persistent.hpp</h1>
<pre style="background-color: #ffffff">

<span style="color: #990000">#ifndef</span> <span style="color: #000000">PERSISTENT_HPP</span>
<span style="color: #990000">#define</span> <span style="color: #000000">PERSISTENT_HPP</span>
<span style="color: #000099">/*------------------------------------------------------------------------------</span>
<span style="color: #000099"></span>
<span style="color: #000099">  Author:    Andy Rushton</span>
<span style="color: #000099">  Copyright: (c) Andy Rushton, 2004</span>
<span style="color: #000099">  License:   BSD License, see ../docs/license.html</span>
<span style="color: #000099"></span>
<span style="color: #000099">  ------------------------------------------------------------------------------*/</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"os_fixes.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"textio.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"persistent_exceptions.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"smart_ptr.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"clonable.hpp"</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;stdlib.h&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;complex&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;deque&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;set&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;map&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;typeinfo&gt;</span>
<span style="color: #990000">#include</span> <span style="color: #009900">&lt;stdexcept&gt;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Note: the exceptions that can be thrown have had to be moved into a</span>
<span style="color: #000099">// separate file (persistent_exceptions.hpp) to avoid an include loop</span>
<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// The format version number currently supported</span>
<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #990000">extern</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">PersistentVersion</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Class defines an interface for use in making polymorphous classes persistent</span>
<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Note that it is derived from the clonable interface - so you must provide</span>
<span style="color: #000099">// that interface too</span>

<span style="color: #990000">class</span> <span style="color: #000000">persistent</span> <span style="color: #330033">:</span> <span style="color: #990000">public</span> <span style="color: #000000">clonable</span>
<span style="color: #330033">{</span>
<span style="color: #990000">public</span><span style="color: #330033">:</span>
  <span style="color: #990000">virtual</span> <span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">;</span>
  <span style="color: #990000">virtual</span> <span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span>  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span> <span style="color: #330033">=</span> <span style="color: #993399">0</span><span style="color: #330033">;</span>
<span style="color: #330033">}</span><span style="color: #330033">;</span>

<span style="color: #990000">typedef</span> <span style="color: #000000">smart_ptr_clone</span><span style="color: #330033">&lt;</span><span style="color: #000000">persistent</span><span style="color: #330033">&gt;</span> <span style="color: #000000">persistent_ptr</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// dump_context controls the formatting of a persistent dump</span>
<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #990000">class</span> <span style="color: #000000">dump_context</span>
<span style="color: #330033">{</span>
<span style="color: #990000">public</span><span style="color: #330033">:</span>
  <span style="color: #000099">// types used in making polymorphous classes persistent using the callback approach</span>

  <span style="color: #000099">// callback function for dumping the class</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">void</span> <span style="color: #330033">(</span><span style="color: #330033">*</span><span style="color: #000000">dump_callback</span><span style="color: #330033">)</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span><span style="color: #990000">const</span> <span style="color: #990000">void</span><span style="color: #330033">*</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// data stored per class registered</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">,</span><span style="color: #000000">dump_callback</span><span style="color: #330033">&gt;</span> <span style="color: #000000">callback_data</span><span style="color: #330033">;</span>

  <span style="color: #000099">// types used in making polymorphous classes persistent using the interface approach</span>
  <span style="color: #000099">// i.e. subclasses of class persistent</span>

  <span style="color: #000099">// data stored per class registered</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">interface_data</span><span style="color: #330033">;</span>

  <span style="color: #000099">// type of callback function used to install all polymorphic classes for either approach</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">void</span> <span style="color: #330033">(</span><span style="color: #330033">*</span><span style="color: #000000">installer</span><span style="color: #330033">)</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">//////////////////////////////////////////////////////////////////////////////</span>

  <span style="color: #000000">dump_context</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">device</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">version</span> <span style="color: #330033">=</span> <span style="color: #000000">PersistentVersion</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #330033">~</span><span style="color: #000000">dump_context</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// low level output used to dump a byte</span>
  <span style="color: #990000">void</span> <span style="color: #000000">put</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// access the device, for example to check the error status</span>
  <span style="color: #990000">const</span> <span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">device</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// recover the version number of the dumped output</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">version</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// test whether the current platform uses little-endian or big-endian addressing of bytes</span>
  <span style="color: #000099">// this is used in dump/restore of integers</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">little_endian</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Pointers</span>
  <span style="color: #000099">// the return pair is a flag saying whether this is a new pointer and the magic key to dump to file</span>
  <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">bool</span><span style="color: #330033">,</span><span style="color: #990000">unsigned</span><span style="color: #330033">&gt;</span> <span style="color: #000000">pointer_map</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #990000">void</span><span style="color: #330033">*</span> <span style="color: #990000">const</span> <span style="color: #000000">pointer</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Polymorphous classes (i.e. subclasses) using callback approach</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">register_type</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span> <span style="color: #000000">info</span><span style="color: #330033">,</span> <span style="color: #000000">dump_callback</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">is_callback</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span> <span style="color: #000000">info</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">callback_data</span> <span style="color: #000000">lookup_type</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_illegal_type</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Polymorphous classes (i.e. subclasses) using interface approach</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">register_interface</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span> <span style="color: #000000">info</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">is_interface</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span> <span style="color: #000000">info</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">interface_data</span> <span style="color: #000000">lookup_interface</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">type_info</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span> <span style="color: #990000">const</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_illegal_type</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Register all Polymorphous classes using either approach by calling an installer callback</span>
  <span style="color: #990000">void</span> <span style="color: #000000">register_all</span><span style="color: #330033">(</span><span style="color: #000000">installer</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">private</span><span style="color: #330033">:</span>
  <span style="color: #000099">// internals</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">,</span><span style="color: #000000">callback_data</span><span style="color: #330033">&gt;</span> <span style="color: #000000">callback_map</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">,</span><span style="color: #000000">interface_data</span><span style="color: #330033">&gt;</span> <span style="color: #000000">interface_map</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #990000">const</span> <span style="color: #990000">void</span><span style="color: #330033">*</span><span style="color: #330033">,</span><span style="color: #990000">unsigned</span><span style="color: #330033">&gt;</span> <span style="color: #000000">magic_map</span><span style="color: #330033">;</span>

  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">m_max_key</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">m_version</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">m_little_endian</span><span style="color: #330033">;</span>
  <span style="color: #000000">otext</span> <span style="color: #000000">m_device</span><span style="color: #330033">;</span>
  <span style="color: #000000">magic_map</span> <span style="color: #000000">m_pointers</span><span style="color: #330033">;</span>
  <span style="color: #000000">callback_map</span> <span style="color: #000000">m_callbacks</span><span style="color: #330033">;</span>
  <span style="color: #000000">interface_map</span> <span style="color: #000000">m_interfaces</span><span style="color: #330033">;</span>

  <span style="color: #000099">// disallow copying by making assignment and copy constructor private</span>
  <span style="color: #000000">dump_context</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span><span style="color: #330033">=</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #330033">}</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// restore_context controls the reading of the persistent data during a restore</span>

<span style="color: #990000">class</span> <span style="color: #000000">restore_context</span>
<span style="color: #330033">{</span>
<span style="color: #990000">public</span><span style="color: #330033">:</span>
  <span style="color: #000099">// types used in making polymorphous classes persistent using the callback approach</span>

  <span style="color: #000099">// callback function for creating a new object of the class and returning the pointer</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">void</span><span style="color: #330033">*</span> <span style="color: #330033">(</span><span style="color: #330033">*</span><span style="color: #000000">create_callback</span><span style="color: #330033">)</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// callback for restoring the contents of a new object created by the create_callback and passed as the second argument</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">void</span> <span style="color: #330033">(</span><span style="color: #330033">*</span><span style="color: #000000">restore_callback</span><span style="color: #330033">)</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span><span style="color: #990000">void</span><span style="color: #330033">*</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000099">// data stored per class registered</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #000000">create_callback</span><span style="color: #330033">,</span> <span style="color: #000000">restore_callback</span><span style="color: #330033">&gt;</span> <span style="color: #000000">callback_data</span><span style="color: #330033">;</span>

  <span style="color: #000099">// types used in making polymorphous classes persistent using the interface approach</span>
  <span style="color: #000099">// i.e. subclasses of class persistent</span>

  <span style="color: #000099">// data stored per class registered</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">persistent_ptr</span> <span style="color: #000000">interface_data</span><span style="color: #330033">;</span>

  <span style="color: #000099">// type of callback function used to install all polymorphic classes for either approach</span>
  <span style="color: #990000">typedef</span> <span style="color: #990000">void</span> <span style="color: #330033">(</span><span style="color: #330033">*</span><span style="color: #000000">installer</span><span style="color: #330033">)</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">//////////////////////////////////////////////////////////////////////////////</span>

  <span style="color: #000000">restore_context</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">itext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">device</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #330033">~</span><span style="color: #000000">restore_context</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// low level input used to restore a byte</span>
  <span style="color: #990000">int</span> <span style="color: #000000">get</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// access the device, for example to check the error status</span>
  <span style="color: #990000">const</span> <span style="color: #000000">itext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">device</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// access the version number of the input being restored</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">version</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// test whether the current platform uses little-endian or big-endian addressing of bytes</span>
  <span style="color: #000099">// this is used in dump/restore of integers</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">little_endian</span><span style="color: #330033">(</span><span style="color: #990000">void</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Pointers</span>
  <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #990000">bool</span><span style="color: #330033">,</span><span style="color: #990000">void</span><span style="color: #330033">*</span><span style="color: #330033">&gt;</span> <span style="color: #000000">pointer_map</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #000000">magic</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">void</span> <span style="color: #000000">pointer_add</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #000000">magic</span><span style="color: #330033">,</span> <span style="color: #990000">void</span><span style="color: #330033">*</span> <span style="color: #000000">new_pointer</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Polymorphous classes using the callback approach</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">register_type</span><span style="color: #330033">(</span><span style="color: #000000">create_callback</span><span style="color: #330033">,</span><span style="color: #000000">restore_callback</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">is_callback</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">callback_data</span> <span style="color: #000000">lookup_type</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">)</span> <span style="color: #990000">const</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_illegal_type</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Assist functions for Polymorphous classes using the interface approach</span>
  <span style="color: #000099">// the object class must be a derivative of class persistent - i.e. it must implement the persistent interface</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">register_interface</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">persistent_ptr</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">is_interface</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">)</span> <span style="color: #990000">const</span><span style="color: #330033">;</span>
  <span style="color: #000000">interface_data</span> <span style="color: #000000">lookup_interface</span><span style="color: #330033">(</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">)</span> <span style="color: #990000">const</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_illegal_type</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

  <span style="color: #000099">// Register all Polymorphous classes using either approach by calling an installer callback</span>
  <span style="color: #990000">void</span> <span style="color: #000000">register_all</span><span style="color: #330033">(</span><span style="color: #000000">installer</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">private</span><span style="color: #330033">:</span>
  <span style="color: #000099">// internals</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">,</span><span style="color: #000000">callback_data</span><span style="color: #330033">&gt;</span> <span style="color: #000000">callback_map</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">,</span><span style="color: #000000">interface_data</span><span style="color: #330033">&gt;</span> <span style="color: #000000">interface_map</span><span style="color: #330033">;</span>
  <span style="color: #990000">typedef</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #990000">unsigned</span><span style="color: #330033">,</span><span style="color: #990000">void</span><span style="color: #330033">*</span><span style="color: #330033">&gt;</span> <span style="color: #000000">magic_map</span><span style="color: #330033">;</span>

  <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span> <span style="color: #000000">m_max_key</span><span style="color: #330033">;</span>
  <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span> <span style="color: #000000">m_version</span><span style="color: #330033">;</span>
  <span style="color: #990000">bool</span> <span style="color: #000000">m_little_endian</span><span style="color: #330033">;</span>
  <span style="color: #000000">itext</span> <span style="color: #000000">m_device</span><span style="color: #330033">;</span>
  <span style="color: #000000">magic_map</span> <span style="color: #000000">m_pointers</span><span style="color: #330033">;</span>
  <span style="color: #000000">callback_map</span> <span style="color: #000000">m_callbacks</span><span style="color: #330033">;</span>
  <span style="color: #000000">interface_map</span> <span style="color: #000000">m_interfaces</span><span style="color: #330033">;</span>

  <span style="color: #000099">// disallow copying by making assignment and copy constructor private</span>
  <span style="color: #000000">restore_context</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
  <span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span> <span style="color: #990000">operator</span><span style="color: #330033">=</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #330033">}</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Integers</span>

<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">bool</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">bool</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">signed</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">signed</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">char</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">short</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">short</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">short</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">int</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">int</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">unsigned</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">long</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">long</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">long</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">unsigned</span> <span style="color: #990000">long</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Floating point types</span>
<span style="color: #000099">//</span>
<span style="color: #000099">// Note: despite years and years of IEEE standardisation, not all</span>
<span style="color: #000099">// architectures use IEEE-standard representations of floating-point numbers.</span>
<span style="color: #000099">// Therefore a binary dump is not necessarily portable between platforms.</span>
<span style="color: #000099">// Solving this is (currently) beyond the scope of the STLplus project.</span>

<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">float</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">float</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #990000">double</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">double</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// enumeration types</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_enum</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_enum</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// C-style char arrays.</span>
<span style="color: #000099">// These are handled differently to other pointer types as below</span>

<span style="color: #000099">// Warning! This means that pointers to char cannot be supported, since there</span>
<span style="color: #000099">// is no type difference between a pointer to char and a C-style array of char</span>

<span style="color: #000099">// Warning! The restore deletes any old value of the data parameter and</span>
<span style="color: #000099">// allocates a new char* which is (just) big enough and assigns it to the data</span>
<span style="color: #000099">// field. This is because there is no way of knowing how long a char* is so</span>
<span style="color: #000099">// the passed parameter is not safe to use. The allocation is done using</span>
<span style="color: #000099">// standard new. If the data field is non-null on entry it will be deleted by</span>
<span style="color: #000099">// standard delete. Best to make it null in the first place.</span>

<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">char</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">char</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// STL strings</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">charT</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">traits</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">allocator</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_basic_string</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">basic_string</span><span style="color: #330033">&lt;</span><span style="color: #000000">charT</span><span style="color: #330033">,</span><span style="color: #000000">traits</span><span style="color: #330033">,</span><span style="color: #000000">allocator</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">charT</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">traits</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">allocator</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_basic_string</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">basic_string</span><span style="color: #330033">&lt;</span><span style="color: #000000">charT</span><span style="color: #330033">,</span><span style="color: #000000">traits</span><span style="color: #330033">,</span><span style="color: #000000">allocator</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">void</span> <span style="color: #000000">dump</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Pointers</span>

<span style="color: #000099">// Supports null pointers too!</span>

<span style="color: #000099">// Warning! The pointer must be a dynamically-allocated type, since the implementation uses new/delete</span>
<span style="color: #000099">// If the data field to restore is null and the file format non-null, allocates a new T()</span>
<span style="color: #000099">// If the data field is non-null and the file format is null, deletes it and sets it null</span>

<span style="color: #000099">// Multiple pointers to the same object *will* be restored as multiple</span>
<span style="color: #000099">// pointers to the same object. The object is dumped only the first time it is</span>
<span style="color: #000099">// encountered along with a "magic key". Subsequent pointers to the same</span>
<span style="color: #000099">// object cause only the magic key to be dumped. On restore, the object is</span>
<span style="color: #000099">// only restored once and the magic keys are matched up so that the other</span>
<span style="color: #000099">// pointers now pojnt to the restored object.</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_pointer</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">*</span> <span style="color: #990000">const</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_pointer</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Cross-references</span>
<span style="color: #000099">// A cross-reference is a pointer to an object that has definitely been dumped</span>
<span style="color: #000099">// already by one of dump_pointer, dump_interface or dump_polymorph, i.e. by</span>
<span style="color: #000099">// one of the dump routines for pointers to objects.</span>
<span style="color: #000099">//</span>
<span style="color: #000099">// These are typically used in data structures as back-pointers or pointers</span>
<span style="color: #000099">// between nodes.</span>
<span style="color: #000099">//</span>
<span style="color: #000099">// For example, you may have a tree with cross links. Dump the tree as the</span>
<span style="color: #000099">// primary data structure and then dump the cross links as cross-references.</span>
<span style="color: #000099">// These functions will throw an exception if the cross-reference points to</span>
<span style="color: #000099">// something not dumped before.</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_xref</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">*</span> <span style="color: #990000">const</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_xref</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Polymorphous types using the callback approach</span>
<span style="color: #000099">// These are always dumped/restored as pointers to the superclass T.</span>

<span style="color: #000099">// Multiple pointers to the same object are handled in the same way as above</span>
<span style="color: #000099">// for simple pointers</span>

<span style="color: #000099">// Only classes registered with the context can be dumped and restored as</span>
<span style="color: #000099">// polymorphic types - see dump_context::register_type and restore_context::register_type.</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_polymorph</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">*</span> <span style="color: #990000">const</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_polymorph</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// Polymorphous types using the interface approach</span>
<span style="color: #000099">// These are always dumped/restored as pointers to the superclass T.</span>

<span style="color: #000099">// Multiple pointers to the same object are handled in the same way as above</span>
<span style="color: #000099">// for simple pointers</span>

<span style="color: #000099">// Only classes registered with the context can be dumped and restored as</span>
<span style="color: #000099">// polymorphic types - see dump_context::register_interface and restore_context::register_interface</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_interface</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">*</span> <span style="color: #990000">const</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_interface</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">*</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// STL Containers</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #000000">size_t</span> <span style="color: #000000">N</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_bitset</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">bitset</span><span style="color: #330033">&lt;</span><span style="color: #000000">N</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #000000">size_t</span> <span style="color: #000000">N</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_bitset</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">bitset</span><span style="color: #330033">&lt;</span><span style="color: #000000">N</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_complex</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">complex</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_complex</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">complex</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_deque</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">deque</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_deque</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">deque</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_list</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">list</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_list</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">list</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_pair</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_pair</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">pair</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_map</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_map</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">map</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_multimap</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">multimap</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_multimap</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">multimap</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">T</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_set</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">set</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_set</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">set</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_multiset</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">multiset</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">K</span><span style="color: #330033">,</span> <span style="color: #990000">typename</span> <span style="color: #000000">P</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_multiset</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">multiset</span><span style="color: #330033">&lt;</span><span style="color: #000000">K</span><span style="color: #330033">,</span><span style="color: #000000">P</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_vector</span><span style="color: #330033">(</span><span style="color: #000000">dump_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">vector</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_vector</span><span style="color: #330033">(</span><span style="color: #000000">restore_context</span><span style="color: #330033">&amp;</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">vector</span><span style="color: #330033">&lt;</span><span style="color: #000000">T</span><span style="color: #330033">&gt;</span><span style="color: #330033">&amp;</span> <span style="color: #000000">data</span><span style="color: #330033">)</span> <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #000099">// short-cut functions for dumping and restoring to common targets</span>
<span style="color: #000099">//</span>
<span style="color: #000099">// These functions use the installer callback function to install any</span>
<span style="color: #000099">// polymorphic type handlers required. If there are no polymorphic types used</span>
<span style="color: #000099">// in the data structure, then the callback can be set to null (i.e. 0).</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_to_device</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">source</span><span style="color: #330033">,</span> <span style="color: #000000">otext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">result</span><span style="color: #330033">,</span> <span style="color: #000000">dump_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_from_device</span><span style="color: #330033">(</span><span style="color: #000000">itext</span><span style="color: #330033">&amp;</span> <span style="color: #000000">source</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">result</span><span style="color: #330033">,</span> <span style="color: #000000">restore_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_to_string</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">source</span><span style="color: #330033">,</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">result</span><span style="color: #330033">,</span> <span style="color: #000000">dump_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_from_string</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">source</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">result</span><span style="color: #330033">,</span> <span style="color: #000000">restore_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">dump_to_file</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">source</span><span style="color: #330033">,</span> <span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">filename</span><span style="color: #330033">,</span> <span style="color: #000000">dump_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_dump_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>
<span style="color: #990000">template</span><span style="color: #330033">&lt;</span><span style="color: #990000">typename</span> <span style="color: #000000">T</span><span style="color: #330033">&gt;</span>
<span style="color: #990000">void</span> <span style="color: #000000">restore_from_file</span><span style="color: #330033">(</span><span style="color: #990000">const</span> <span style="color: #000000">std</span><span style="color: #330033">::</span><span style="color: #000000">string</span><span style="color: #330033">&amp;</span> <span style="color: #000000">filename</span><span style="color: #330033">,</span> <span style="color: #000000">T</span><span style="color: #330033">&amp;</span> <span style="color: #000000">result</span><span style="color: #330033">,</span> <span style="color: #000000">restore_context</span><span style="color: #330033">::</span><span style="color: #000000">installer</span> <span style="color: #000000">installer</span><span style="color: #330033">)</span>
  <span style="color: #990000">throw</span><span style="color: #330033">(</span><span style="color: #000000">persistent_restore_failed</span><span style="color: #330033">)</span><span style="color: #330033">;</span>

<span style="color: #000099">////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #990000">#include</span> <span style="color: #009900">"persistent.tpp"</span>
<span style="color: #990000">#endif</span>
</pre>
</body>
</html>
